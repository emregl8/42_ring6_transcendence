apiVersion: v1
kind: ConfigMap
metadata:
  name: vault-auto-unseal-script
  namespace: transcendence
data:
  vault-auto-unseal.sh: |
    #!/bin/sh

    VAULT_ADDR="${VAULT_ADDR:-https://127.0.0.1:8200}"
    export VAULT_SKIP_VERIFY=1

    echo "Starting vault auto-unseal service..."

    check_unseal_keys() {
        [ -f /vault/unseal/key-1 ] && [ -f /vault/unseal/key-2 ] && [ -f /vault/unseal/key-3 ]
    }

    is_sealed() {
        vault status -format=json 2>/dev/null | jq -r '.sealed' 2>/dev/null || echo "true"
    }

    is_vault_ready() {
        vault status -format=json >/dev/null 2>&1
        rc=$?
        [ "$rc" -eq 0 ] || [ "$rc" -eq 2 ]
    }

    unseal_vault() {
        if ! check_unseal_keys; then
            return 1
        fi

        if [ "$(is_sealed)" = "false" ]; then
            return 0
        fi

        echo "Unsealing vault..."
        for i in 1 2 3; do
            KEY=$(tr -d '\r\n' < "/vault/unseal/key-$i")
            vault operator unseal "$KEY" >/dev/null 2>&1 || true
        done

        sleep 1
        if [ "$(is_sealed)" = "false" ]; then
            echo "Vault unsealed successfully"
            return 0
        fi
        return 1
    }

    echo "Waiting for vault to be ready and monitoring for seal status..."

    while true; do
        if is_vault_ready; then
            unseal_vault || true
        fi
        sleep 10
    done
