apiVersion: v1
kind: ConfigMap
metadata:
  name: vault-auto-unseal-script
  namespace: transcendence
data:
  vault-auto-unseal.sh: |
    #!/bin/sh

    set -e

    POD_NAME="${POD_NAME:-$(hostname)}"
    VAULT_ADDR="${VAULT_ADDR:-https://127.0.0.1:8200}"
    export VAULT_SKIP_VERIFY=1

    echo "Auto-unseal starting for $POD_NAME"

    check_unseal_keys() {
        if [ ! -f /vault/unseal/key-1 ] || [ ! -f /vault/unseal/key-2 ] || [ ! -f /vault/unseal/key-3 ]; then
            echo "ERROR: Unseal keys not found"
            return 1
        fi
        return 0
    }

    is_sealed() {
        vault status -format=json 2>/dev/null | jq -r '.sealed' 2>/dev/null || echo "true"
    }

    wait_for_vault() {
        local max_attempts=30
        local attempt=0

        while [ $attempt -lt $max_attempts ]; do
            vault status -format=json >/dev/null 2>&1
            rc=$?
            if [ "$rc" -eq 0 ] || [ "$rc" -eq 2 ]; then
                return 0
            fi
            attempt=$((attempt + 1))
            if [ $((attempt % 5)) -eq 1 ]; then
                echo "Waiting for Vault... ($attempt/$max_attempts)"
            fi
            sleep 2
        done

        echo "ERROR: Vault not ready after $max_attempts attempts"
        return 1
    }

    unseal_vault() {
        if ! check_unseal_keys; then
            return 1
        fi

        local sealed
        sealed=$(is_sealed)

        if [ "$sealed" = "false" ]; then
            echo "Vault already unsealed"
            return 0
        fi

        echo "Unsealing Vault..."
        
        for i in 1 2 3; do
            KEY=$(tr -d '\r\n' < "/vault/unseal/key-$i")
            vault operator unseal "$KEY" >/dev/null 2>&1 || true
        done

        sleep 1
        sealed=$(is_sealed)
        if [ "$sealed" = "false" ]; then
            echo "Vault unsealed successfully"
            return 0
        else
            echo "ERROR: Vault still sealed"
            return 1
        fi
    }

    monitor_and_unseal() {
        while true; do
            if wait_for_vault; then
                unseal_vault || echo "Unseal failed, retrying..."
            fi

            sleep 30
        done
    }

    echo "Initial unseal check..."
    if wait_for_vault; then
        unseal_vault || echo "Initial unseal failed, monitoring..."
    fi

    echo "Starting monitoring (30s intervals)..."
    monitor_and_unseal
